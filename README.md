# HUST-ComputerComposition-Design-dinosaur
华中科技大学计算机科学与技术学院计算机组成原理课设团队任务，在FPGA开发板上实现了一个支持rv32im指令集的CPU，并在上面运行一个模仿chrome浏览器的小恐龙的游戏。

![dino](./dino.png)
## 详细介绍
详见`dino.pptx`，是最后答辩用的PPT。

## 硬件部分
硬件部分，从零开始使用FPGA写一个CPU太累了，因此我们直接在学长的[CarrotIsYou](https://github.com/SmokeyDays/CarrotIsYou)项目中的基础上，按照我们的需求进行修改而实现的CPU。

### 外设管理方法
通过MMIO，把外部设备的地址空间映射到内存地址空间。在CPU内部的取数与存数阶段，对于目的地址加了一层判断，如果这个地址是已经规划的外设的地址，则会对这个外设所对应的存储空间进行操作而非到RAM的空间中去寻址

### VGA
沿用了学长的代码

### 新的问题改进
+ 在Nexys4开发板上，通过连接键盘的方式来来进行游戏交互，非常容易出现因为键盘电压不足而操纵失灵的问题。
  + 小恐龙游戏只需要一个开始按钮和一个跳跃按钮（未设计下蹲姿态），可以直接使用开发板自带的按键。
  + 为开发板自带的button设置一个button_State寄存器，用来存放当前按钮的状态，并且为这个寄存器映射一个特殊的地址，供软件访问。
  + 通过轮询的方式访问button_state的地址，因为频率很高，远高于手指离开按钮的速度，不用担心按钮信号持续时间太短而导致操作没有被识别的情况。
  + 对button_state设计时设置了一个自锁的结构，一旦按过一次即使松开，这个寄存器的值就一直是1，直到软件层次对这个寄存器进行访问之后这个寄存器的值才会清空，在硬件层次上对于游戏的操作的灵敏度与可靠性做了保障。
  

## 软件部分
软件部分的代码详见`software/`下。该部分的代码实际上来源于在开发阶段就建立的仓库[sdl-dino](https://github.com/CassiusBlackX/sdl-dino)

其中，`baremetal`分支中的内容才是用来上开发板的代码，没有使用任何第三方库和标准库，同时准备了相应的交叉编译的脚本，继承到CMake中，在编译的时候只用通过cmake就可以一次性生成最后需要的所有文件。

## 彩蛋(BUG)——飞翔的恐龙
在上板以后，当恐龙处于jumping状态的时候，按下reset(start)按钮，恐龙将保持飞行状态。

但是这个特性非常方便检查，随着游戏分数的升高，障碍物的移动速度是否也会跟着变高（这样才符合游戏难度逐渐提升的原版特性）

本质上是因为状态机的状态转换部分没有处理清楚，不过美名其曰“致敬任天堂在《魂斗罗》中留下来的作弊码”。

## BUG: 碰撞检测不正确
因为VGA显式的硬件部分完全沿用了学长的代码，所以显式的效果完全由软件部分根据硬件部分做相应的适配和修改。但是在原始硬件代码中，有一个像素放大的功能，在硬件级别把所有的像素放大了3被，导致碰撞检测的逻辑失效。虽然软件层面来说恐龙并没有与障碍物碰撞，但是在显示效果中已经完全撞上去了。